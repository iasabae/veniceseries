<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>베네치아 급수 게임</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: 
                /* 구름 효과 */
                radial-gradient(ellipse at 20% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 35%),
                radial-gradient(ellipse at 40% 10%, rgba(255, 255, 255, 0.15) 0%, transparent 30%),
                /* 태양 효과 */
                radial-gradient(circle at 85% 15%, rgba(255, 215, 0, 0.4) 0%, rgba(255, 165, 0, 0.2) 20%, transparent 40%),
                /* 하늘 그라데이션 */
                linear-gradient(180deg, 
                    #87CEEB 0%, 
                    #4682B4 30%, 
                    #5F9EA0 60%, 
                    #2F4F4F 80%, 
                    #1e3a5f 100%);
            overflow: hidden;
            height: 100vh;
            touch-action: none;
            animation: skyBreathing 20s ease-in-out infinite alternate;
        }

        @keyframes skyBreathing {
            0% {
                filter: brightness(1) saturate(1);
            }
            100% {
                filter: brightness(1.1) saturate(1.2);
            }
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: 
                /* 구름 움직임 효과 */
                radial-gradient(ellipse at 15% 25%, rgba(255, 255, 255, 0.25) 0%, transparent 45%),
                radial-gradient(ellipse at 75% 15%, rgba(255, 255, 255, 0.2) 0%, transparent 40%),
                radial-gradient(ellipse at 45% 5%, rgba(255, 255, 255, 0.15) 0%, transparent 35%),
                /* 새들 실루엣 */
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M10,10 Q12,8 14,10 Q16,8 18,10 M30,12 Q32,10 34,12 Q36,10 38,12 M60,8 Q62,6 64,8 Q66,6 68,8" stroke="%23ffffff" stroke-width="0.8" fill="none" opacity="0.4"/></svg>') repeat-x,
                /* 물결 효과 */
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0,15 Q25,10 50,15 T100,15" stroke="%23ffffff" stroke-width="0.6" fill="none" opacity="0.3"/></svg>') repeat-x bottom;
            background-size: auto, auto, 200px 30px, 150px 20px;
            background-position: 0 0, 0 0, 0 20px, 0 bottom;
            display: none;
            animation: backgroundFloat 30s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% {
                background-position: 0 0, 0 0, 0 20px, 0 bottom;
            }
            50% {
                background-position: -50px 0, 30px 0, -100px 25px, -75px bottom;
            }
        }

        #gameContainer.active {
            display: block;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(135deg, 
                rgba(0,0,0,0.3) 0%, 
                rgba(0,0,0,0.1) 100%);
            backdrop-filter: blur(15px) saturate(1.2);
            border-radius: 15px;
            padding: 12px 16px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 
                0 6px 24px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.1);
        }

        #score {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        #hearts {
            font-size: 20px;
            margin-bottom: 8px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        #level {
            font-size: 18px;
            font-weight: 700;
            color: #87CEEB;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        .series {
            position: absolute;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.98) 0%, 
                rgba(240, 248, 255, 0.95) 50%, 
                rgba(230, 245, 255, 0.92) 100%);
            border: 4px solid transparent;
            background-clip: padding-box;
            border-radius: 20px;
            padding: 20px 25px;
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.4),
                0 5px 15px rgba(0,0,0,0.2),
                inset 0 2px 0 rgba(255,255,255,0.8),
                inset 0 -2px 0 rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
            backdrop-filter: blur(15px) saturate(1.2);
            font-family: 'Times New Roman', serif;
            color: #1a365d;
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 160px;
            min-height: 80px;
            transform: scale(1);
            animation: seriesGlow 4s ease-in-out infinite alternate;
        }

        .series::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, 
                rgba(255, 107, 107, 0.7) 0%,
                rgba(255, 159, 64, 0.6) 15%,
                rgba(255, 206, 84, 0.5) 30%,
                rgba(75, 192, 192, 0.4) 45%,
                rgba(54, 162, 235, 0.3) 60%,
                rgba(153, 102, 255, 0.2) 75%,
                rgba(255, 99, 132, 0.1) 100%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
            filter: blur(2px);
            animation: circularPulse 2s ease-in-out infinite;
        }

        .series:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.5),
                0 10px 25px rgba(0,0,0,0.3),
                inset 0 2px 0 rgba(255,255,255,0.9);
        }

        .series .MathJax {
            font-size: 1.5em !important;
            color: #1a365d !important;
        }

        .series .MathJax_Display {
            margin: 0 !important;
        }

        .series mjx-container {
            color: #1a365d !important;
        }

        .series mjx-container mjx-math {
            color: #1a365d !important;
        }

        @keyframes seriesGlow {
            0% {
                box-shadow: 
                    0 15px 35px rgba(0,0,0,0.4),
                    0 5px 15px rgba(0,0,0,0.2),
                    inset 0 2px 0 rgba(255,255,255,0.8),
                    0 0 20px rgba(255, 107, 107, 0.4);
            }
            100% {
                box-shadow: 
                    0 15px 35px rgba(0,0,0,0.4),
                    0 5px 15px rgba(0,0,0,0.2),
                    inset 0 2px 0 rgba(255,255,255,0.8),
                    0 0 30px rgba(153, 102, 255, 0.6);
            }
        }

        @keyframes circularPulse {
            0% {
                width: 20px;
                height: 20px;
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                width: 140px;
                height: 140px;
                opacity: 0.3;
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                width: 20px;
                height: 20px;
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes failShake {
            0%, 100% { 
                transform: translateX(0);
                opacity: 1;
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
            100% {
                opacity: 0;
            }
        }

        .bomb {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 5px solid rgba(255,255,255,0.9);
            font-size: 20px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.4),
                0 3px 10px rgba(0,0,0,0.3),
                inset 0 3px 6px rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
        }

        .convergent-bomb {
            background: radial-gradient(circle at 30% 30%, 
                #66BB6A 0%, 
                #4CAF50 30%, 
                #2E7D32 70%, 
                #1B5E20 100%);
            border-color: rgba(200, 230, 201, 0.9);
            box-shadow: 
                0 8px 25px rgba(76, 175, 80, 0.7), 
                0 3px 10px rgba(76, 175, 80, 0.5),
                inset 0 3px 6px rgba(255,255,255,0.4),
                0 0 20px rgba(76, 175, 80, 0.3);
            animation: convergentPulse 2s ease-in-out infinite alternate;
        }

        .convergent-bomb::before {
            content: "✓";
            font-size: 36px;
            color: white;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.8),
                0 0 10px rgba(255,255,255,0.5);
            font-weight: 900;
        }

        .divergent-bomb {
            background: radial-gradient(circle at 30% 30%, 
                #EF5350 0%, 
                #F44336 30%, 
                #C62828 70%, 
                #B71C1C 100%);
            border-color: rgba(255, 205, 210, 0.9);
            box-shadow: 
                0 8px 25px rgba(244, 67, 54, 0.7),
                0 3px 10px rgba(244, 67, 54, 0.5),
                inset 0 3px 6px rgba(255,255,255,0.4),
                0 0 20px rgba(244, 67, 54, 0.3);
            animation: divergentPulse 2s ease-in-out infinite alternate;
        }

        .divergent-bomb::before {
            content: "✗";
            font-size: 40px;
            color: white;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.8),
                0 0 10px rgba(255,255,255,0.5);
            font-weight: 900;
        }

        .bomb:hover {
            transform: scale(1.15) translateY(-8px);
            box-shadow: 
                0 15px 40px rgba(0,0,0,0.5),
                0 5px 15px rgba(0,0,0,0.4);
        }

        .bomb:active {
            transform: scale(1.05) translateY(-4px);
        }

        @keyframes convergentPulse {
            0% {
                box-shadow: 
                    0 8px 25px rgba(76, 175, 80, 0.7), 
                    0 3px 10px rgba(76, 175, 80, 0.5),
                    inset 0 3px 6px rgba(255,255,255,0.4),
                    0 0 15px rgba(76, 175, 80, 0.3);
            }
            100% {
                box-shadow: 
                    0 8px 25px rgba(76, 175, 80, 0.7), 
                    0 3px 10px rgba(76, 175, 80, 0.5),
                    inset 0 3px 6px rgba(255,255,255,0.4),
                    0 0 30px rgba(76, 175, 80, 0.6);
            }
        }

        @keyframes divergentPulse {
            0% {
                box-shadow: 
                    0 8px 25px rgba(244, 67, 54, 0.7),
                    0 3px 10px rgba(244, 67, 54, 0.5),
                    inset 0 3px 6px rgba(255,255,255,0.4),
                    0 0 15px rgba(244, 67, 54, 0.3);
            }
            100% {
                box-shadow: 
                    0 8px 25px rgba(244, 67, 54, 0.7),
                    0 3px 10px rgba(244, 67, 54, 0.5),
                    inset 0 3px 6px rgba(255,255,255,0.4),
                    0 0 30px rgba(244, 67, 54, 0.6);
            }
        }

        .bomb-launcher {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 150px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
        }

        .launcher-slot {
            width: 110px;
            height: 110px;
            border: 4px dashed rgba(255,255,255,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, 
                rgba(255,255,255,0.15) 0%, 
                rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(15px) saturate(1.2);
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            animation: slotGlow 3s ease-in-out infinite alternate;
        }

        .launcher-slot:hover {
            border-color: rgba(255,255,255,0.9);
            background: linear-gradient(135deg, 
                rgba(255,255,255,0.25) 0%, 
                rgba(255,255,255,0.1) 100%);
            transform: scale(1.05);
        }

        @keyframes slotGlow {
            0% {
                box-shadow: 
                    0 8px 32px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.2),
                    0 0 20px rgba(255,255,255,0.1);
            }
            100% {
                box-shadow: 
                    0 8px 32px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.2),
                    0 0 30px rgba(255,255,255,0.2);
            }
        }

        .aim-indicator {
            position: absolute;
            width: 130px;
            height: 130px;
            border: 3px dashed rgba(255,255,255,0.8);
            border-radius: 50%;
            display: none;
            z-index: 60;
            pointer-events: none;
        }

        .aim-arrow {
            position: absolute;
            width: 78px; /* 30% 증가 (60 * 1.3) */
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 2px;
            transform-origin: left center;
            display: none;
            z-index: 61;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        .aim-arrow::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid #FFA500;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.6));
        }

        .aiming {
            animation: aimingPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes aimingPulse {
            0% {
                transform: scale(1);
                box-shadow: 
                    0 8px 25px rgba(76, 175, 80, 0.7), 
                    0 3px 10px rgba(76, 175, 80, 0.5),
                    inset 0 3px 6px rgba(255,255,255,0.4),
                    0 0 20px rgba(255, 215, 0, 0.5);
            }
            100% {
                transform: scale(1.05);
                box-shadow: 
                    0 8px 25px rgba(76, 175, 80, 0.7), 
                    0 3px 10px rgba(76, 175, 80, 0.5),
                    inset 0 3px 6px rgba(255,255,255,0.4),
                    0 0 30px rgba(255, 215, 0, 0.8);
            }
        }

        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.8s ease-out forwards;
            z-index: 70;
        }

        .correct-explosion {
            background: radial-gradient(circle, #4CAF50, #81C784, #C8E6C9, transparent);
            box-shadow: 0 0 50px #4CAF50, 0 0 100px #4CAF50;
        }

        .series-explosion {
            background: radial-gradient(circle, #FFD700, #FFF176, transparent);
            box-shadow: 0 0 40px #FFD700;
            width: 80px;
            height: 80px;
            animation: seriesExplode 0.6s ease-out forwards;
        }

        .absorption-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, transparent, #F44336, transparent);
            animation: absorb 0.6s ease-in forwards;
            z-index: 70;
        }

        .series-reject-glow {
            position: absolute;
            width: 200px;
            height: 100px;
            border-radius: 15px;
            background: rgba(244, 67, 54, 0.3);
            animation: rejectGlow 0.8s ease-out forwards;
            z-index: 60;
        }

        .score-popup {
            position: absolute;
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: scoreFloat 1s ease-out forwards;
            z-index: 80;
            pointer-events: none;
        }

        .fail-popup {
            position: absolute;
            color: #F44336;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: failShake 1.2s ease-out forwards;
            z-index: 80;
            pointer-events: none;
        }

        @keyframes explode {
            0% { 
                transform: scale(0) rotate(0deg); 
                opacity: 1; 
            }
            30% {
                transform: scale(1.2) rotate(120deg);
                opacity: 0.9;
            }
            70% {
                transform: scale(2) rotate(270deg);
                opacity: 0.6;
            }
            100% { 
                transform: scale(4) rotate(360deg); 
                opacity: 0; 
            }
        }

        @keyframes seriesExplode {
            0% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.3) rotate(180deg);
                opacity: 0.7;
            }
            100% { 
                transform: scale(2.5) rotate(360deg);
                opacity: 0; 
            }
        }

        @keyframes seriesDissolve {
            0% { 
                transform: scale(1);
                opacity: 1;
                filter: brightness(1);
            }
            30% {
                transform: scale(0.9);
                opacity: 0.8;
                filter: brightness(0.5) hue-rotate(180deg);
            }
            70% {
                transform: scale(0.7);
                opacity: 0.4;
                filter: brightness(0.2) hue-rotate(270deg);
            }
            100% { 
                transform: scale(0.3);
                opacity: 0;
                filter: brightness(0) hue-rotate(360deg);
            }
        }

        @keyframes absorb {
            0% { 
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.5);
                opacity: 0.8;
            }
            100% { 
                transform: scale(0);
                opacity: 0; 
            }
        }

        @keyframes rejectGlow {
            0% { 
                opacity: 0;
                transform: scale(1);
            }
            30% {
                opacity: 0.8;
                transform: scale(1.1);
            }
            100% { 
                opacity: 0;
                transform: scale(1);
            }
        }

        @keyframes scoreFloat {
            0% { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% { 
                opacity: 0;
                transform: translateY(-50px) scale(1.5);
            }
        }

        @keyframes wave {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-50px); }
        }

        @keyframes fall {
            from { 
                transform: translateY(-100px); 
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            to { 
                transform: translateY(calc(100vh + 100px)); 
                opacity: 0.8;
            }
        }

        .falling {
            /* CSS 애니메이션은 사용하지 않음 - JavaScript로 제어 */
        }

        #gameIntro {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: 
                /* 구름 효과 */
                radial-gradient(ellipse at 25% 20%, rgba(255, 255, 255, 0.4) 0%, transparent 45%),
                radial-gradient(ellipse at 75% 25%, rgba(255, 255, 255, 0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 10%, rgba(255, 255, 255, 0.2) 0%, transparent 35%),
                radial-gradient(ellipse at 10% 60%, rgba(255, 255, 255, 0.15) 0%, transparent 30%),
                /* 태양 효과 */
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.5) 0%, rgba(255, 165, 0, 0.3) 25%, transparent 45%),
                /* 하늘 그라데이션 */
                linear-gradient(180deg, 
                    #87CEEB 0%, 
                    #4682B4 25%, 
                    #5F9EA0 50%, 
                    #2F4F4F 75%, 
                    #1e3a5f 100%);
            animation: introSkyBreathing 25s ease-in-out infinite alternate;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #gameIntro::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* 건물 실루엣들 */
                linear-gradient(to top,
                    rgba(139, 69, 19, 0.8) 0%,
                    rgba(160, 82, 45, 0.6) 20%,
                    transparent 25%
                ) 5% bottom / 12% 15% no-repeat,
                linear-gradient(to top,
                    rgba(160, 82, 45, 0.9) 0%,
                    rgba(205, 133, 63, 0.7) 15%,
                    transparent 20%
                ) 85% bottom / 15% 18% no-repeat,
                linear-gradient(to top,
                    rgba(139, 69, 19, 0.7) 0%,
                    rgba(160, 82, 45, 0.5) 25%,
                    transparent 30%
                ) 65% bottom / 10% 12% no-repeat,
                linear-gradient(to top,
                    rgba(205, 133, 63, 0.8) 0%,
                    rgba(210, 180, 140, 0.6) 18%,
                    transparent 22%
                ) 25% bottom / 8% 14% no-repeat,
                /* 전체 어두운 오버레이 */
                rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        #gameIntro::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25%;
            background: 
                /* 물결 반사 효과 */
                radial-gradient(ellipse at 20% 30%, rgba(135, 206, 235, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(70, 130, 180, 0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 40%, rgba(255, 215, 0, 0.2) 0%, transparent 30%),
                /* 물 색상 */
                linear-gradient(180deg, 
                    rgba(30, 58, 95, 0.8) 0%, 
                    rgba(25, 45, 75, 0.9) 50%, 
                    rgba(15, 20, 25, 0.95) 100%);
            z-index: -1;
            animation: introWaterFlow 12s ease-in-out infinite;
        }

        @keyframes introSkyBreathing {
            0%, 100% {
                filter: brightness(1) saturate(1.1);
            }
            50% {
                filter: brightness(1.15) saturate(1.3);
            }
        }

        @keyframes introWaterFlow {
            0%, 100% { 
                transform: translateX(0);
                filter: brightness(1) saturate(1);
            }
            33% {
                transform: translateX(-15px);
                filter: brightness(1.1) saturate(1.2);
            }
            66% {
                transform: translateX(10px);
                filter: brightness(1.05) saturate(1.1);
            }
        }

        @keyframes waterFlow {
            0%, 100% { 
                transform: translateX(0);
                opacity: 0.6;
            }
            50% { 
                transform: translateX(-20px);
                opacity: 0.8;
            }
        }

        #gameIntro h1 {
            font-size: 32px;
            margin-bottom: 30px;
            color: #4CAF50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #gameIntro .intro-content {
            max-width: 400px;
            margin-bottom: 40px;
        }

        #gameIntro .rule {
            background: 
                linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.15) 0%, 
                    rgba(255, 255, 255, 0.08) 100%);
            border-radius: 15px;
            padding: 18px 20px;
            margin: 12px 0;
            backdrop-filter: blur(15px) saturate(1.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: ruleFloat 8s ease-in-out infinite alternate;
        }

        #gameIntro .rule:hover {
            transform: translateY(-2px);
            background: 
                linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.2) 0%, 
                    rgba(255, 255, 255, 0.12) 100%);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.15);
        }

        @keyframes ruleFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        #gameIntro .rule h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #81C784;
        }

        #gameIntro .rule p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        #startButton {
            font-size: 26px;
            padding: 18px 45px;
            background: 
                linear-gradient(135deg, 
                    #4CAF50 0%, 
                    #66BB6A 50%, 
                    #81C784 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 
                0 8px 25px rgba(76, 175, 80, 0.5),
                0 4px 15px rgba(76, 175, 80, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            animation: buttonPulse 3s ease-in-out infinite;
        }

        #startButton::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            transition: left 0.6s ease;
        }

        #startButton:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 
                0 12px 35px rgba(76, 175, 80, 0.7),
                0 6px 20px rgba(76, 175, 80, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        #startButton:hover::before {
            left: 100%;
        }

        #startButton:active {
            transform: translateY(-2px) scale(1.02);
        }

        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 
                    0 8px 25px rgba(76, 175, 80, 0.5),
                    0 4px 15px rgba(76, 175, 80, 0.3),
                    inset 0 2px 4px rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow: 
                    0 10px 30px rgba(76, 175, 80, 0.7),
                    0 5px 18px rgba(76, 175, 80, 0.5),
                    inset 0 2px 4px rgba(255, 255, 255, 0.25);
            }
        }

        #gameOver button {
            font-size: 18px;
            padding: 12px 30px;
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        #gameOver button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 200;
            border: 2px solid #4CAF50;
        }

        .building {
            position: absolute;
            bottom: 140px;
            background: linear-gradient(180deg, 
                #D2691E 0%, 
                #CD853F 20%, 
                #A0522D 50%, 
                #8B4513 80%, 
                #654321 100%);
            border-top: 3px solid #654321;
            border-radius: 8px 8px 0 0;
            box-shadow: 
                0 0 20px rgba(0, 0, 0, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            animation: buildingSway 15s ease-in-out infinite alternate;
        }

        .building::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 20%;
            width: 60%;
            height: 8px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 215, 0, 0.6) 20%, 
                rgba(255, 215, 0, 0.8) 50%, 
                rgba(255, 215, 0, 0.6) 80%, 
                transparent 100%);
            border-radius: 4px;
        }

        .building::after {
            content: '';
            position: absolute;
            top: 25%;
            left: 15%;
            width: 70%;
            height: 6px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 30%, 
                rgba(255, 255, 255, 0.5) 50%, 
                rgba(255, 255, 255, 0.3) 70%, 
                transparent 100%);
            border-radius: 3px;
        }

        @keyframes buildingSway {
            0%, 100% {
                transform: translateY(0);
                filter: brightness(1);
            }
            50% {
                transform: translateY(-2px);
                filter: brightness(1.1);
            }
        }

        .building1 {
            left: 10%;
            width: 80px;
            height: 120px;
            animation-delay: 0s;
        }

        .building2 {
            right: 15%;
            width: 100px;
            height: 150px;
            animation-delay: 5s;
        }

        .building3 {
            left: 70%;
            width: 60px;
            height: 100px;
            animation-delay: 10s;
        }

        .water {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 140px;
            background: 
                /* 물결 반사 효과 */
                radial-gradient(ellipse at 30% 20%, rgba(135, 206, 235, 0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 30%, rgba(70, 130, 180, 0.2) 0%, transparent 35%),
                /* 기본 물 색상 */
                linear-gradient(180deg, 
                    rgba(30, 58, 95, 0.9) 0%, 
                    rgba(25, 45, 75, 0.95) 50%, 
                    rgba(15, 20, 25, 1) 100%);
            opacity: 0.9;
            animation: waterShimmer 8s ease-in-out infinite alternate;
        }

        .water::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 15"><path d="M0,8 Q25,3 50,8 T100,8" stroke="%23ffffff" stroke-width="1.2" fill="none" opacity="0.5"/></svg>') repeat-x,
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 10"><path d="M0,5 Q37.5,2 75,5 T150,5" stroke="%2387CEEB" stroke-width="0.8" fill="none" opacity="0.3"/></svg>') repeat-x;
            background-size: 100px 15px, 150px 10px;
            animation: wave 4s ease-in-out infinite, waveSecond 6s ease-in-out infinite reverse;
        }

        .water::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 15px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 8"><path d="M0,4 Q30,1 60,4 T120,4" stroke="%234682B4" stroke-width="0.6" fill="none" opacity="0.4"/></svg>') repeat-x;
            background-size: 120px 8px;
            animation: wave 5s ease-in-out infinite reverse;
        }

        @keyframes waterShimmer {
            0%, 100% {
                filter: brightness(1) saturate(1);
            }
            50% {
                filter: brightness(1.2) saturate(1.3);
            }
        }

        @keyframes waveSecond {
            0%, 100% { 
                transform: translateX(0); 
            }
            50% { 
                transform: translateX(-30px); 
            }
        }

        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 0, 0, 0.6);
            z-index: 1000;
            pointer-events: none;
            animation: flashScreen 0.5s ease-out forwards;
        }

        @keyframes flashScreen {
            0% { opacity: 0; }
            30% { opacity: 1; }
            100% { opacity: 0; }
        }

        .sup {
            font-size: 0.7em;
            vertical-align: super;
        }

        .sub {
            font-size: 0.7em;
            vertical-align: sub;
        }

        .series-hint {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 90;
        }
    </style>
</head>
<body>
    <div id="gameIntro">
        <h1>🌊 베네치아 급수 게임 🌊</h1>
        <div class="intro-content">
            <div class="rule">
                <h3>🎯 게임 목표</h3>
                <p>하늘에서 떨어지는 급수의 수렴/발산을 판정하고<br>올바른 폭탄으로 맞춰보세요!</p>
            </div>
            <div class="rule">
                <h3>🎮 조작 방법</h3>
                <p><span style="color: #4CAF50;">수렴폭탄(✓)</span> 또는 <span style="color: #F44336;">발산폭탄(✗)</span>을<br>클릭해서 조준하고, 다시 클릭해서 발사하세요!</p>
            </div>
            <div class="rule">
                <h3>💡 급수 예시</h3>
                <p>∑ 1/n² → 수렴 (p-급수, p>1)<br>∑ 1/n → 발산 (조화급수)<br>∑ 2ⁿ → 발산 (기하급수, r>1)</p>
            </div>
            <div class="rule">
                <h3>❤️ 생명</h3>
                <p>급수가 물에 닿거나 틀리면 하트 감소<br>5번 실수하면 게임 오버!</p>
            </div>
        </div>
        <button id="startButton">게임 시작</button>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="water"></div>
        <div class="building building1"></div>
        <div class="building building2"></div>
        <div class="building building3"></div>

        <div id="ui">
            <div id="score">점수: 0</div>
            <div id="hearts">❤️ ❤️ ❤️ ❤️ ❤️</div>
            <div id="level">레벨: 1</div>
        </div>

        <div class="series-hint" id="seriesHint" style="display: none;">
            수렴/발산 판정을 생각해보세요!
        </div>

        <div class="bomb-launcher">
            <div class="launcher-slot" id="convergentSlot">
                <div class="bomb convergent-bomb" id="convergentBomb"></div>
            </div>
            <div class="launcher-slot" id="divergentSlot">
                <div class="bomb divergent-bomb" id="divergentBomb"></div>
            </div>
        </div>

        <div class="aim-indicator" id="aimIndicator"></div>
        <div class="aim-arrow" id="aimArrow"></div>



        <div id="gameOver">
            <h2>🎮 게임 오버! 🎮</h2>
            <p>최종 점수: <span id="finalScore">0</span></p>
            <p>레벨: <span id="finalLevel">1</span></p>
            <button id="restartButton">🔄 다시 시작</button>
        </div>
    </div>

    <script>
        class VeniceSeriesGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                this.score = 0;
                this.hearts = 5;
                this.level = 1;
                this.series = [];
                this.bombs = [];
                this.explosions = [];
                this.gameRunning = false;
                this.gameStarted = false;
                this.activeColumns = []; // 현재 활성 열 추적
                
                this.isAiming = false;
                this.aimingBombType = null;
                this.aimingBomb = null;
                this.aimAngle = 0;
                this.aimDirection = 1; // 1 for increasing, -1 for decreasing
                this.aimIndicator = document.getElementById('aimIndicator');
                this.aimArrow = document.getElementById('aimArrow');
                this.aimAnimationId = null;
                
                this.seriesPool = [
                    { 
                        display: '$\\sum \\frac{1}{n}$', 
                        convergent: false, 
                        name: "조화급수 (발산)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n^2}$', 
                        convergent: true, 
                        name: "p-급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{\\sqrt{n}}$', 
                        convergent: false, 
                        name: "p-급수 (발산)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{2^n}$', 
                        convergent: true, 
                        name: "기하급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{3^n}$', 
                        convergent: true, 
                        name: "기하급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum 2^n$', 
                        convergent: false, 
                        name: "기하급수 (발산)" 
                    },
                    { 
                        display: '$\\sum \\frac{2^n}{n!}$', 
                        convergent: true, 
                        name: "비율판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{n!}{n^n}$', 
                        convergent: true, 
                        name: "비율판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{(-1)^n}{n}$', 
                        convergent: true, 
                        name: "교대급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{(-1)^n}{\\sqrt{n}}$', 
                        convergent: true, 
                        name: "교대급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{n}{n^2+1}$', 
                        convergent: false, 
                        name: "극한비교 (발산)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n \\ln n}$', 
                        convergent: false, 
                        name: "적분판정법 (발산)" 
                    },
                    { 
                        display: '$\\sum \\frac{\\ln n}{n^2}$', 
                        convergent: true, 
                        name: "적분판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{n^2}{2^n}$', 
                        convergent: true, 
                        name: "비율판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n^3}$', 
                        convergent: true, 
                        name: "p-급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{\\sin n}{n^2}$', 
                        convergent: true, 
                        name: "비교판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n^4}$', 
                        convergent: true, 
                        name: "p-급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{n}{2^n}$', 
                        convergent: true, 
                        name: "비율판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n^{3/2}}$', 
                        convergent: true, 
                        name: "p-급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n \\ln^2 n}$', 
                        convergent: true, 
                        name: "적분판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{(-1)^{n+1}}{n^2}$', 
                        convergent: true, 
                        name: "교대급수 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{n}{3^n}$', 
                        convergent: true, 
                        name: "비율판정법 (수렴)" 
                    },
                    { 
                        display: '$\\sum \\frac{1}{n^{1/2}}$', 
                        convergent: false, 
                        name: "p-급수 (발산)" 
                    },
                    { 
                        display: '$\\sum \\frac{n^3}{e^n}$', 
                        convergent: true, 
                        name: "비율판정법 (수렴)" 
                    },
                    {
                        display: '$\\sum \\frac{1}{n^2}$',
                        convergent: true,
                        name: "적분판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n}$',
                        convergent: false,
                        name: "적분판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n \\ln n}$',
                        convergent: false,
                        name: "적분판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n (\\ln n)^2}$',
                        convergent: true,
                        name: "적분판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{n}{e^n}$',
                        convergent: true,
                        name: "적분판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{\\sqrt{n}}$',
                        convergent: false,
                        name: "적분판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n^{3/2}}$',
                        convergent: true,
                        name: "적분판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{\\ln n}{n^2}$',
                        convergent: true,
                        name: "적분판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{n}{n+1}$',
                        convergent: false,
                        name: "발산판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{2n^2 + 1}{3n^2 + 5}$',
                        convergent: false,
                        name: "발산판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\sin n$',
                        convergent: false,
                        name: "발산판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\cos\\left(\\frac{1}{n}\\right)$',
                        convergent: false,
                        name: "발산판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{n!}{10^n}$',
                        convergent: false,
                        name: "발산판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{n^2}{2^n}$',
                        convergent: true,
                        name: "비율판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{3n + 1}{2n + 5}$',
                        convergent: false,
                        name: "발산판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{1}{2^n + 1}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n^2 + 1}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{2n + 1}{n^3 + 1}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{\\sin^2 n}{n^2}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{\\sqrt{n^2 + 1}}$',
                        convergent: false,
                        name: "비교판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n^2 - 1}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{n + 1}{n^4 + n^2}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{3^n - 1}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{n!}{3^n}$',
                        convergent: false,
                        name: "비율판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{2^n}{n!}$',
                        convergent: true,
                        name: "비율판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{n^3}{2^n}$',
                        convergent: true,
                        name: "비율판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{3^n}{n^2}$',
                        convergent: false,
                        name: "비율판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{n^n}{n! \\cdot 2^n}$',
                        convergent: false,
                        name: "비율판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{(2n)!}{(n!)^2 \\cdot 4^n}$',
                        convergent: false,
                        name: "비율판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\frac{n! \\cdot 2^n}{(2n)!}$',
                        convergent: true,
                        name: "비율판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{5^n}{n \\cdot 3^n}$',
                        convergent: false,
                        name: "비율판정법 (발산)"
                    },
                    {
                        display: '$\\sum \\left(\\frac{2n}{3n+1}\\right)^n$',
                        convergent: true,
                        name: "근판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\left(\\frac{n}{n+1}\\right)^{n^2}$',
                        convergent: true,
                        name: "근판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n^n}$',
                        convergent: true,
                        name: "근판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\left(\\frac{3n+1}{4n-1}\\right)^n$',
                        convergent: true,
                        name: "근판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\left(\\frac{\\ln n}{n}\\right)^n$',
                        convergent: true,
                        name: "근판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\left(\\frac{1}{\\ln n}\\right)^n$',
                        convergent: true,
                        name: "근판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{1}{n^2 + n}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    },
                    {
                        display: '$\\sum \\frac{n^2 + 1}{n^4 + 2n + 1}$',
                        convergent: true,
                        name: "비교판정법 (수렴)"
                    }
                ];
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.gameLoop(); // 게임 루프는 항상 실행
                // spawnSeries는 게임 시작 후에만 호출
            }
            
            startGameFromIntro() {
                const gameIntro = document.getElementById('gameIntro');
                const gameContainer = document.getElementById('gameContainer');
                if (gameIntro) {
                    gameIntro.style.display = 'none';
                }
                if (gameContainer) {
                    gameContainer.classList.add('active');
                }
                this.startGame();
            }
            
            startGame() {
                this.gameRunning = true;
                this.gameStarted = true;
                this.spawnSeries();
            }
            
            setupEventListeners() {
                const startButton = document.getElementById('startButton');
                if (startButton) {
                    startButton.addEventListener('click', () => {
                        this.startGameFromIntro();
                    });
                }
                
                const convergentBomb = document.getElementById('convergentBomb');
                const divergentBomb = document.getElementById('divergentBomb');
                
                if (convergentBomb && divergentBomb) {
                    this.addClickListeners(convergentBomb, 'convergent');
                    this.addClickListeners(divergentBomb, 'divergent');
                }
            }
            
            addClickListeners(element, type) {
                // 마우스 이벤트
                element.addEventListener('click', (e) => this.handleBombClick(element, type));
                
                // 터치 이벤트
                element.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.handleBombClick(element, type);
                });
            }
            
            handleBombClick(element, type) {
                if (!this.gameRunning) return;
                
                if (this.isAiming && this.aimingBombType === type) {
                    // 두 번째 클릭 - 발사
                    this.fireBomb();
                } else {
                    // 첫 번째 클릭 - 조준 시작
                    this.startAiming(element, type);
                }
            }
            
            startAiming(element, type) {
                // 기존 조준 중지
                this.stopAiming();
                
                this.isAiming = true;
                this.aimingBombType = type;
                this.aimingBomb = element;
                this.aimAngle = 0;
                this.aimDirection = 1;
                
                // 폭탄에 조준 중 표시
                element.classList.add('aiming');
                
                // 조준 UI 표시
                const rect = element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                this.aimIndicator.style.left = (centerX - 65) + 'px';
                this.aimIndicator.style.top = (centerY - 65) + 'px';
                this.aimIndicator.style.display = 'block';
                
                this.aimArrow.style.left = centerX + 'px';
                this.aimArrow.style.top = (centerY - 2) + 'px';
                this.aimArrow.style.display = 'block';
                
                // 조준 애니메이션 시작
                this.startAimAnimation();
            }
            
            startAimAnimation() {
                const animate = () => {
                    if (!this.isAiming) return;
                    
                    // 각도 업데이트 (0도에서 180도 사이) - 속도 50% 증가
                    this.aimAngle += this.aimDirection * 2; // 2에서 3으로 증가 (50% 증가)
                    
                    if (this.aimAngle >= 180) {
                        this.aimAngle = 180;
                        this.aimDirection = -1;
                    } else if (this.aimAngle <= 0) {
                        this.aimAngle = 0;
                        this.aimDirection = 1;
                    }
                    
                    // 화살표 회전 (180도 빼서 올바른 방향으로)
                    const displayAngle = this.aimAngle - 180;
                    this.aimArrow.style.transform = `rotate(${displayAngle}deg)`;
                    
                    this.aimAnimationId = requestAnimationFrame(animate);
                };
                animate();
            }
            
            stopAiming() {
                if (this.aimingBomb) {
                    this.aimingBomb.classList.remove('aiming');
                }
                
                this.isAiming = false;
                this.aimingBombType = null;
                this.aimingBomb = null;
                
                this.aimIndicator.style.display = 'none';
                this.aimArrow.style.display = 'none';
                
                if (this.aimAnimationId) {
                    cancelAnimationFrame(this.aimAnimationId);
                    this.aimAnimationId = null;
                }
            }
            
            getAvailableColumn() {
                const columnWidth = 150; // 카드 하나가 차지하는 폭
                const maxColumns = Math.floor((this.canvas.width - 300) / columnWidth);
                
                // 사용 가능한 열들을 모두 찾기
                const availableColumns = [];
                
                for (let i = 0; i < maxColumns; i++) {
                    const columnX = 150 + i * columnWidth;
                    
                    // 이 열에 최근 2초 이내에 생성된 카드가 있는지 확인
                    const hasRecentCard = this.activeColumns.some(col => 
                        Math.abs(col.x - columnX) < 100 && 
                        Date.now() - col.time < 2000
                    );
                    
                    if (!hasRecentCard) {
                        availableColumns.push(columnX);
                    }
                }
                
                // 사용 가능한 열이 있으면 랜덤하게 선택
                if (availableColumns.length > 0) {
                    return availableColumns[Math.floor(Math.random() * availableColumns.length)];
                }
                
                // 모든 열이 사용 중이면 랜덤한 열 사용
                return 150 + Math.floor(Math.random() * maxColumns) * columnWidth;
            }
            
            spawnSeries() {
                if (!this.gameRunning) return;
                
                const seriesData = this.seriesPool[Math.floor(Math.random() * this.seriesPool.length)];
                const columnX = this.getAvailableColumn();
                
                // 기본 속도를 더 느리게 설정하고 레벨에 따라 점진적으로 증가
                let baseSpeed = 0.3 + this.level * 0.25;
                
                // 확률적으로 더 빠른 카드 생성 (20% 확률)
                const speedMultiplier = Math.random();
                if (speedMultiplier < 0.07) {
                    baseSpeed *= 1.5; // 50% 더 빠르게
                } else if (speedMultiplier < 0.2) {
                    baseSpeed *= 1.3; // 30% 더 빠르게
                }
                
                const series = {
                    x: columnX,
                    y: -50,
                    speed: baseSpeed,
                    convergent: seriesData.convergent,
                    display: seriesData.display,
                    element: this.createSeriesElement(seriesData)
                };
                
                // 활성 열에 추가
                this.activeColumns.push({
                    x: columnX,
                    time: Date.now()
                });
                
                // 오래된 열 정보 정리 (3초 이상 된 것들)
                this.activeColumns = this.activeColumns.filter(col => 
                    Date.now() - col.time < 3000
                );
                
                this.series.push(series);
                
                setTimeout(() => this.spawnSeries(), Math.max(5000 - this.level * 100, 800));
            }
            
            createSeriesElement(seriesData) {
                const div = document.createElement('div');
                div.className = 'series';
                div.innerHTML = seriesData.display;
                div.style.left = '0px';
                div.style.top = '0px';
                
                // CSS 애니메이션 대신 JavaScript로 움직임 제어
                div.style.animation = 'none';
                
                document.getElementById('gameContainer').appendChild(div);
                
                // MathJax로 수식 렌더링
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([div]).catch((err) => console.log(err));
                }
                
                return div;
            }
            
            fireBomb() {
                if (!this.isAiming) return;
                
                const rect = this.aimingBomb.getBoundingClientRect();
                const startX = rect.left + rect.width / 2;
                const startY = rect.top + rect.height / 2;
                
                // 각도를 라디안으로 변환 (180도 빼서 올바른 방향으로)
                const angleRad = (this.aimAngle - 180) * Math.PI / 180;
                const speed = 20;
                
                const bomb = {
                    x: startX,
                    y: startY,
                    vx: Math.cos(angleRad) * speed,
                    vy: Math.sin(angleRad) * speed,
                    type: this.aimingBombType,
                    element: this.createFlyingBombElement(this.aimingBombType)
                };
                
                this.bombs.push(bomb);
                
                // 조준 모드 종료
                this.stopAiming();
            }
            
            createFlyingBombElement(type) {
                const div = document.createElement('div');
                div.className = `bomb ${type}-bomb`;
                div.style.width = '40px';
                div.style.height = '40px';
                div.style.fontSize = '12px';
                document.getElementById('gameContainer').appendChild(div);
                return div;
            }
            
            update() {
                // Update series - JavaScript로 직접 움직임 제어
                this.series = this.series.filter(s => {
                    s.y += s.speed; // 매 프레임마다 위치 업데이트
                    s.element.style.left = s.x + 'px';
                    s.element.style.top = s.y + 'px';
                    
                    // 투명도도 위치에 따라 조정
                    if (s.y < 0) {
                        s.element.style.opacity = '0';
                    } else if (s.y < 50) {
                        s.element.style.opacity = (s.y / 50).toString();
                    } else {
                        s.element.style.opacity = '1';
                    }
                    
                    // 화면 아래로 벗어나면 제거
                    if (s.y > this.canvas.height - 160) {
                        s.element.remove();
                        this.loseHeart(); // 화면 깜박 효과 포함
                        return false;
                    }
                    return true;
                });
                
                // Update bombs
                this.bombs = this.bombs.filter(b => {
                    b.x += b.vx;
                    b.y += b.vy;
                    b.element.style.left = b.x + 'px';
                    b.element.style.top = b.y + 'px';
                    
                    if (b.x < -50 || b.x > this.canvas.width + 50 || b.y < -50 || b.y > this.canvas.height + 50) {
                        b.element.remove();
                        return false;
                    }
                    
                    // Check collision with series
                    for (let i = 0; i < this.series.length; i++) {
                        const s = this.series[i];
                        if (this.checkCollision(b, s)) {
                            this.handleCollision(b, s, i);
                            b.element.remove();
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                // Update explosions
                this.explosions = this.explosions.filter(e => {
                    e.time -= 16;
                    if (e.time <= 0) {
                        e.element.remove();
                        return false;
                    }
                    return true;
                });
            }
            
            checkCollision(bomb, series) {
                const seriesRect = series.element.getBoundingClientRect();
                const bombSize = 40; // 폭탄 크기의 절반
                
                // 급수카드의 실제 화면 위치와 크기
                const cardLeft = series.x;
                const cardRight = series.x + seriesRect.width;
                const cardTop = series.y;
                const cardBottom = series.y + seriesRect.height;
                
                // 폭탄의 영역
                const bombLeft = bomb.x - bombSize/2;
                const bombRight = bomb.x + bombSize/2;
                const bombTop = bomb.y - bombSize/2;
                const bombBottom = bomb.y + bombSize/2;
                
                // 사각형 충돌 감지 (AABB - Axis Aligned Bounding Box)
                return !(bombRight < cardLeft || 
                        bombLeft > cardRight || 
                        bombBottom < cardTop || 
                        bombTop > cardBottom);
            }
            
            handleCollision(bomb, series, seriesIndex) {
                const correct = (bomb.type === 'convergent') === series.convergent;
                
                if (correct) {
                    // 정답 - 폭발 효과
                    this.createCorrectExplosion(bomb.x, bomb.y, series.x + 60, series.y + 25);
                    this.score += 10 * this.level;
                    this.updateScore();
                    
                    // 급수가 폭발과 함께 즉시 사라짐
                    series.element.style.animation = 'seriesExplode 0.4s ease-out forwards';
                    setTimeout(() => {
                        if (series.element && series.element.parentNode) {
                            series.element.remove();
                        }
                    }, 400);
                    
                } else {
                    // 오답 - 폭탄 흡수 효과 후 카드도 사라짐
                    this.createAbsorptionEffect(bomb.x, bomb.y, series.x + 60, series.y + 25);
                    this.loseHeart();
                    
                    // 오답이어도 카드는 사라짐 (흡수 효과 후)
                    series.element.style.animation = 'seriesDissolve 0.6s ease-out forwards';
                    setTimeout(() => {
                        if (series.element && series.element.parentNode) {
                            series.element.remove();
                        }
                    }, 600);
                }
                
                // 배열에서 급수 제거
                this.series.splice(seriesIndex, 1);
            }
            
            createCorrectExplosion(bombX, bombY, seriesX, seriesY) {
                // 메인 폭발 효과
                const explosion = document.createElement('div');
                explosion.className = 'explosion correct-explosion';
                explosion.style.left = (bombX - 50) + 'px';
                explosion.style.top = (bombY - 50) + 'px';
                document.getElementById('gameContainer').appendChild(explosion);
                
                // 급수 위치에서의 추가 폭발 (정확한 중심점 사용)
                const seriesExplosion = document.createElement('div');
                seriesExplosion.className = 'explosion series-explosion';
                seriesExplosion.style.left = (seriesX - 40) + 'px';
                seriesExplosion.style.top = (seriesY - 40) + 'px';
                document.getElementById('gameContainer').appendChild(seriesExplosion);
                
                // 점수 표시 효과
                const scorePopup = document.createElement('div');
                scorePopup.className = 'score-popup';
                scorePopup.textContent = `+${10 * this.level}`;
                scorePopup.style.left = seriesX + 'px';
                scorePopup.style.top = (seriesY - 20) + 'px';
                document.getElementById('gameContainer').appendChild(scorePopup);
                
                this.explosions.push(
                    { element: explosion, time: 800 },
                    { element: seriesExplosion, time: 800 },
                    { element: scorePopup, time: 1000 }
                );
            }
            
            createAbsorptionEffect(bombX, bombY, seriesX, seriesY) {
                // 폭탄이 급수로 빨려들어가는 효과
                const absorption = document.createElement('div');
                absorption.className = 'absorption-effect';
                absorption.style.left = (bombX - 30) + 'px';
                absorption.style.top = (bombY - 30) + 'px';
                document.getElementById('gameContainer').appendChild(absorption);
                
                // 급수가 빨갛게 빛나는 효과 (정확한 중심점 사용)
                const seriesGlow = document.createElement('div');
                seriesGlow.className = 'series-reject-glow';
                seriesGlow.style.left = (seriesX - 40) + 'px';
                seriesGlow.style.top = (seriesY - 20) + 'px';
                seriesGlow.style.width = '80px';
                seriesGlow.style.height = '40px';
                document.getElementById('gameContainer').appendChild(seriesGlow);
                
                // 실패 표시
                const failPopup = document.createElement('div');
                failPopup.className = 'fail-popup';
                failPopup.textContent = '틀렸어요!';
                failPopup.style.left = seriesX + 'px';
                failPopup.style.top = (seriesY - 20) + 'px';
                document.getElementById('gameContainer').appendChild(failPopup);
                
                this.explosions.push(
                    { element: absorption, time: 600 },
                    { element: seriesGlow, time: 800 },
                    { element: failPopup, time: 1200 }
                );
            }
            
            loseHeart() {
                this.hearts--;
                this.updateHearts();
                this.createScreenFlash(); // 화면 깜박 효과
                if (this.hearts <= 0) {
                    this.gameOver();
                }
            }
            
            createScreenFlash() {
                const flash = document.createElement('div');
                flash.className = 'screen-flash';
                document.body.appendChild(flash);
                
                setTimeout(() => {
                    flash.remove();
                }, 500);
            }
            
            updateScore() {
                document.getElementById('score').textContent = `점수: ${this.score}`;
                if (this.score > 0 && this.score % 100 === 0) {
                    this.level++;
                    document.getElementById('level').textContent = `레벨: ${this.level}`;
                }
            }
            
            updateHearts() {
                const heartsText = '❤️'.repeat(this.hearts) + '🖤'.repeat(5 - this.hearts);
                document.getElementById('hearts').textContent = heartsText;
            }
            
            gameOver() {
                this.gameRunning = false;
                this.gameStarted = false;
                this.stopAiming(); // 조준 모드 정리
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalLevel').textContent = this.level;
                document.getElementById('gameOver').style.display = 'block';
                
                // 다시하기 버튼 이벤트 리스너 추가 (중복 방지)
                const restartButton = document.getElementById('restartButton');
                if (restartButton && !restartButton.hasAttribute('data-listener-added')) {
                    restartButton.addEventListener('click', () => {
                        this.restartGame();
                    });
                    restartButton.setAttribute('data-listener-added', 'true');
                }
            }
            
            restartGame() {
                this.resetGame();
                this.startGame();
            }
            
            resetGame() {
                // 게임 상태 초기화
                this.score = 0;
                this.hearts = 5;
                this.level = 1;
                this.gameRunning = false;
                this.gameStarted = false;
                
                // 화면 요소들 정리
                this.series.forEach(s => s.element.remove());
                this.bombs.forEach(b => b.element.remove());
                this.explosions.forEach(e => e.element.remove());
                
                this.series = [];
                this.bombs = [];
                this.explosions = [];
                
                // UI 업데이트
                this.updateScore();
                this.updateHearts();
                document.getElementById('level').textContent = `레벨: ${this.level}`;
                
                // 게임 오버 화면 숨김
                document.getElementById('gameOver').style.display = 'none';
                
                // 게임 컨테이너 계속 보이도록 유지
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                    gameContainer.classList.add('active');
                }
            }
            
            gameLoop() {
                // 게임이 시작되었을 때만 업데이트
                if (this.gameRunning && this.gameStarted) {
                    this.update();
                }
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        let game;
        
        function initializeGame() {
            game = new VeniceSeriesGame();
        }
        
        window.addEventListener('load', initializeGame);
        window.addEventListener('resize', () => {
            if (game) {
                game.canvas.width = window.innerWidth;
                game.canvas.height = window.innerHeight;
            }
        });
    </script>
</body>
</html>
</html>
